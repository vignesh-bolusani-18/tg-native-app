const path = require('path');
const createExpoWebpackConfigAsync = require('@expo/webpack-config');
const { createProxyMiddleware } = require('http-proxy-middleware');

module.exports = async function (env, argv) {
  const config = await createExpoWebpackConfigAsync(env, argv);

  // Add setupProxy.js middleware to devServer
  if (config.devServer) {
    config.devServer.setupMiddlewares = (middlewares, devServer) => {
      // Add proxy middleware for API routes
      devServer.app.use(
        [
          '/conversation',
          '/conversations',
          '/renameConversation',
          '/conversationByCompany',
          '/api',
          '/validateUser',
          '/getAccessToken',
          '/companies',
          '/company',
          '/user',
          '/getRefreshToken',
        ],
        createProxyMiddleware({
          target: 'https://api-staging-ap-south-1.truegradient.ai',
          changeOrigin: true,
          logLevel: 'debug',
          onProxyReq: (proxyReq, req, res) => {
            console.log(`ðŸ”„ Proxy: ${req.method} ${req.path} -> AWS Backend`);
          },
          onProxyRes: (proxyRes, req, res) => {
            console.log(`âœ… Proxy Response: ${req.method} ${req.path} - Status ${proxyRes.statusCode}`);
          },
        })
      );

      return middlewares;
    };
  }

  return config;
};
